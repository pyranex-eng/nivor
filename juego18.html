<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Soldado Granada</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            touch-action: manipulation;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(to bottom, #1c3a6b, #0e1a2d);
            color: white;
            overflow: hidden;
            height: 100vh;
            touch-action: none;
        }

        #game-container {
            position: relative;
            width: 100%;
            height: 100vh;
            margin: 0 auto;
            overflow: hidden;
        }

        #score, #lives, #level {
            position: absolute;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            z-index: 10;
        }

        #score {
            top: 20px;
            left: 20px;
        }

        #lives {
            top: 20px;
            right: 20px;
        }

        #level {
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
        }

        #soldier {
            position: absolute;
            bottom: 150px;
            left: 50%;
            transform: translateX(-50%);
            width: 30px;
            height: 60px;
            z-index: 5;
            transition: left 0.1s linear, bottom 0.1s linear;
        }

        .soldier-body {
            position: absolute;
            width: 20px;
            height: 25px;
            background-color: #4C721D;
            border-radius: 5px 5px 0 0;
            bottom: 20px;
            left: 5px;
            z-index: 2;
        }

        .soldier-head {
            position: absolute;
            top: 0;
            left: 5px;
            width: 20px;
            height: 20px;
            background-color: #FFCD9E;
            border-radius: 50%;
            z-index: 3;
        }

        .soldier-helmet {
            position: absolute;
            top: -3px;
            left: 3px;
            width: 20px;
            height: 12px;
            background-color: #3A5F0B;
            border-radius: 50% 50% 0 0;
            z-index: 4;
        }

        .soldier-arm {
            position: absolute;
            width: 6px;
            height: 15px;
            background-color: #4C721D;
            z-index: 2;
            transform-origin: top center;
        }

        .soldier-arm.left {
            top: 15px;
            left: 0;
            transform: rotate(20deg);
        }

        .soldier-arm.right {
            top: 15px;
            right: 0;
            transform: rotate(-20deg);
        }

        .soldier-leg {
            position: absolute;
            width: 6px;
            height: 20px;
            background-color: #3A5F0B;
            bottom: 0;
            z-index: 1;
        }

        .soldier-leg.left {
            left: 7px;
        }

        .soldier-leg.right {
            right: 7px;
        }

        .walking .soldier-leg.left {
            animation: walkLeft 0.4s infinite alternate;
        }

        .walking .soldier-leg.right {
            animation: walkRight 0.4s infinite alternate;
        }

        .walking .soldier-arm.left {
            animation: armSwingLeft 0.4s infinite alternate;
        }

        .walking .soldier-arm.right {
            animation: armSwingRight 0.4s infinite alternate;
        }

        @keyframes walkLeft {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-8px) rotate(-15deg); }
        }

        @keyframes walkRight {
            0% { transform: translateY(0) rotate(0deg); }
            100% { transform: translateY(-8px) rotate(15deg); }
        }

        @keyframes armSwingLeft {
            0% { transform: rotate(10deg); }
            100% { transform: rotate(40deg); }
        }

        @keyframes armSwingRight {
            0% { transform: rotate(-10deg); }
            100% { transform: rotate(-40deg); }
        }

        .grenade-throw .soldier-arm.right {
            animation: throwArm 0.3s forwards;
        }

        @keyframes throwArm {
            0% { transform: rotate(-20deg); }
            50% { transform: rotate(-120deg); }
            100% { transform: rotate(-20deg); }
        }

        .ground {
            position: absolute;
            bottom: 0;
            width: 100%;
            height: 100px;
            z-index: 2;
        }

        .grass {
            position: absolute;
            height: 100%;
            background: linear-gradient(to bottom, #2E7D32, #1B5E20);
            width: 20%;
        }

        .grass.left {
            left: 0;
        }

        .dirt-path {
            position: absolute;
            left: 20%;
            width: 60%;
            height: 100%;
            background: linear-gradient(to bottom, #8B4513, #654321);
            background-image:
                repeating-linear-gradient(
                    90deg,
                    transparent,
                    transparent 10px,
                    rgba(0,0,0,0.1) 10px,
                    rgba(0,0,0,0.1) 20px
                );
        }

        .grass.right {
            right: 0;
        }

        #background-elements {
            background-color: #2E7D32;
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            z-index: 1;
            transition: transform 2s ease-out;
        }

        .grass-patch {
            position: absolute;
            width: 60px;
            height: 30px;
            background-color: #2e7d32;
            border-radius: 50%;
            bottom: 100px;
            z-index: 4;
            overflow: hidden;
            transition: transform 1s ease-out;
        }

        .grass-patch:after {
            content: '';
            position: absolute;
            width: 40px;
            height: 20px;
            background-color: #1b5e20;
            border-radius: 50%;
            top: 5px;
            left: 10px;
        }

        .grass-patch-type-1 {
            background-color: #2e7d32;
        }

        .grass-patch-type-1:after {
            background-color: #1b5e20;
        }

        .grass-patch-type-2 {
            background-color: #388e3c;
        }

        .grass-patch-type-2:after {
            background-color: #1b5e20;
            width: 50px;
            height: 25px;
            left: 5px;
        }

        .grass-patch-type-3 {
            background-color: #689f38;
            width: 50px;
            height: 25px;
        }

        .grass-patch-type-3:after {
            background-color: #33691e;
            width: 30px;
            height: 15px;
            left: 10px;
        }

        .tree {
            position: absolute;
            z-index: 3;
            transition: transform 1s ease-out;
        }

        .tree-trunk {
            position: absolute;
            width: 15px;
            height: 40px;
            background: linear-gradient(to bottom, #5D4037, #4E342E);
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            border-radius: 3px 3px 0 0;
        }

        .tree-top {
            position: absolute;
            width: 50px;
            height: 50px;
            background: radial-gradient(circle at 20px 20px, #388E3C, #1B5E20);
            border-radius: 50%;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
        }

        .enemy {
            position: absolute;
            width: 30px;
            height: 60px;
            bottom: 100px;
            z-index: 3;
            display: none;
        }

        .enemy-head {
            position: absolute;
            top: 0;
            left: 5px;
            width: 20px;
            height: 20px;
            background-color: #FFCD9E;
            border-radius: 50%;
            z-index: 3;
        }

        .enemy-helmet {
            position: absolute;
            top: -6px;
            left: 3px;
            width: 20px;
            height: 12px;
            background-color: #6D4C41;
            border-radius: 50% 50% 0 0;
            z-index: 4;
        }

        .moving .enemy-helmet {
            animation: helmetShake 0.6s infinite alternate;
        }

        @keyframes helmetShake {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(5deg); }
        }

        .enemy-body {
            position: absolute;
            width: 20px;
            height: 25px;
            background-color: #8D6E63;
            border-radius: 5px 5px 0 0;
            bottom: 20px;
            left: 5px;
            z-index: 2;
        }

        .enemy-arm {
            position: absolute;
            width: 6px;
            height: 15px;
            background-color: #8D6E63;
            z-index: 2;
            transform-origin: top center;
        }

        .enemy-arm.left {
            top: 15px;
            left: 0;
            transform: rotate(20deg);
        }

        .enemy-arm.right {
            top: 15px;
            right: 0;
            transform: rotate(-20deg);
        }

        .enemy-leg {
            position: absolute;
            width: 6px;
            height: 20px;
            background-color: #5D4037;
            bottom: 0;
            z-index: 1;
        }

        .enemy-leg.left {
            left: 7px;
        }

        .enemy-leg.right {
            right: 7px;
        }

        .moving .enemy-leg.left {
            animation: walkLeft 0.6s infinite alternate;
        }

        .moving .enemy-leg.right {
            animation: walkRight 0.6s infinite alternate;
        }

        .moving .enemy-arm.left {
            animation: armSwingLeft 0.6s infinite alternate;
        }

        .moving .enemy-arm.right {
            animation: armSwingRight 0.6s infinite alternate;
        }

        .enemy-weapon {
            position: absolute;
            width: 20px;
            height: 6px;
            background: linear-gradient(to right, #555, #777);
            z-index: 3;
            top: 18px;
            right: -10px;
            border-radius: 2px;
        }

        .enemy-weapon:after {
            content: '';
            position: absolute;
            width: 5px;
            height: 10px;
            background: linear-gradient(to bottom, #777, #999);
            top: -2px;
            right: 0;
            border-radius: 2px 2px 0 0;
        }

        .crab-moving {
            animation: crabWalk 1.5s infinite alternate ease-in-out;
        }

        @keyframes crabWalk {
            0% { transform: translateX(0); }
            100% { transform: translateX(10px); }
        }

        .grenade {
            position: absolute;
            width: 15px;
            height: 15px;
            background: radial-gradient(circle at 5px 5px, #555, #2c3e50);
            border-radius: 50%;
            z-index: 6;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.5);
            animation: grenadeSpin 0.5s infinite linear;
        }

        .grenade:after {
            content: '';
            position: absolute;
            width: 5px;
            height: 5px;
            background-color: #ff6b6b;
            top: 2px;
            left: 5px;
            border-radius: 50%;
        }

        @keyframes grenadeSpin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        .explosion {
            position: absolute;
            width: 80px;
            height: 80px;
            background: radial-gradient(circle, #ff8800 0%, #ff5500 40%, transparent 70%);
            border-radius: 50%;
            z-index: 6;
            opacity: 0;
            animation: explode 0.3s forwards;
            box-shadow: 0 0 20px #ff5500;
        }

        @keyframes explode {
            0% { transform: scale(0); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.8; }
            100% { transform: scale(1); opacity: 0; }
        }

        .explosion-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, #ffcc00, #ff5500);
            border-radius: 50%;
            z-index: 6;
            animation: particleMove 0.3s forwards;
        }

        @keyframes particleMove {
            0% { transform: translate(0, 0) scale(1); opacity: 1; }
            100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
        }

        .bullet {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: #f7d75a;
            border-radius: 50%;
            box-shadow: 0 0 5px #f7d75a;
            z-index: 5;
            animation: bulletFlash 0.3s infinite alternate;
        }

        @keyframes bulletFlash {
            from { transform: scale(1); opacity: 1; }
            to { transform: scale(1.2); opacity: 0.8; }
        }

        #controls {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            z-index: 10;
        }

        .movement-controls, .grenade-controls {
            display: grid;
            grid-template-areas:
                ". up ."
                "left . right"
                ". down .";
            gap: 5px;
            width: 120px;
            height: 120px;
        }

        #controls .movement-controls {
            grid-template-areas:
                ". move-up ."
                "move-left . move-right"
                ". move-down .";
        }
        
        #controls .grenade-controls {
            grid-template-areas:
                ". grenade-up ."
                "grenade-left . grenade-right"
                ". grenade-down .";
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.3);
            border: 2px solid white;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: white;
            user-select: none;
            position: relative;
        }

        #up-btn { grid-area: move-up; }
        #down-btn { grid-area: move-down; }
        #left-btn { grid-area: move-left; }
        #right-btn { grid-area: move-right; }

        #grenade-up-btn { grid-area: grenade-up; }
        #grenade-down-btn { grid-area: grenade-down; }
        #grenade-left-btn { grid-area: grenade-left; }
        #grenade-right-btn { grid-area: grenade-right; }
        
        .grenade-icon {
            width: 25px;
            height: 25px;
            background: radial-gradient(circle at 10px 10px, #555, #2c3e50);
            border-radius: 50%;
            position: relative;
        }
        
        .grenade-icon:after {
            content: '';
            position: absolute;
            width: 7px;
            height: 7px;
            background-color: #ff6b6b;
            top: 3px;
            left: 8px;
            border-radius: 50%;
        }

        .direction-indicator {
            position: absolute;
            font-size: 20px;
        }
        
        .movement-indicator {
            font-size: 28px;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
        }

        #instructions {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: rgba(0, 0, 0, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            width: 80%;
            z-index: 20;
        }

        #start-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #27ae60;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        #game-over {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 30;
        }

        #restart-btn {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #27ae60;
            border: none;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            cursor: pointer;
        }

        .throw-animation {
            position: absolute;
            width: 20px;
            height: 8px;
            background-color: #555;
            border-radius: 4px;
            z-index: 7;
            transform-origin: left center;
        }

        .level-up-animation {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 40px;
            font-weight: bold;
            color: gold;
            text-shadow: 0 0 10px rgba(255,215,0,0.8);
            opacity: 0;
            animation: levelUp 1.5s forwards;
            z-index: 15;
        }

        @keyframes levelUp {
            0% { transform: translate(-50%, -50%) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0) translateY(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(5px) translateY(5px); }
            20%, 40%, 60%, 80% { transform: translateX(-5px) translateY(-5px); }
        }

        .celebration-text, .soldier-text, .enemy-text {
            position: absolute;
            font-size: 24px;
            font-weight: bold;
            color: #ffcc00;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.7);
            z-index: 15;
            white-space: nowrap;
        }

        .celebration-text {
            animation: celebrationFloat 2s forwards;
        }

        .soldier-text {
            animation: celebrationFloat 1.5s forwards;
        }

        .enemy-text {
            animation: enemyTextFloat 1.5s forwards;
        }

        @keyframes celebrationFloat {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -50px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -100px) scale(1); opacity: 0; }
        }

        @keyframes enemyTextFloat {
            0% { transform: translate(-50%, 0) scale(0.5); opacity: 0; }
            50% { transform: translate(-50%, -30px) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -60px) scale(1); opacity: 0; }
        }

        /* Responsive adjustments for controls */
        @media (max-width: 768px) {
            #controls {
                bottom: 120px; /* Moved up for better mobile visibility */
            }
        }
    </style>
</head>
<body>
    <div id="game-container">
        <div id="score">Puntos: 0</div>
        <div id="lives">Vidas: 3</div>
        <div id="level">Nivel: 1</div>

        <div id="background-elements"></div>
        <div class="ground">
            <div class="grass left"></div>
            <div class="dirt-path"></div>
            <div class="grass right"></div>
        </div>
        <div id="soldier">
            <div class="soldier-head"></div>
            <div class="soldier-helmet"></div>
            <div class="soldier-body"></div>
            <div class="soldier-arm left"></div>
            <div class="soldier-arm right"></div>
            <div class="soldier-leg left"></div>
            <div class="soldier-leg right"></div>
        </div>

        <div id="controls">
            <div class="movement-controls">
                <div class="control-btn" id="up-btn"><div class="movement-indicator">‚¨ÜÔ∏è</div></div>
                <div class="control-btn" id="left-btn"><div class="movement-indicator">‚¨ÖÔ∏è</div></div>
                <div class="control-btn" id="right-btn"><div class="movement-indicator">‚û°Ô∏è</div></div>
                <div class="control-btn" id="down-btn"><div class="movement-indicator">‚¨áÔ∏è</div></div>
            </div>
            <div class="grenade-controls">
                <div class="control-btn" id="grenade-up-btn"><div class="grenade-icon"></div></div>
                <div class="control-btn" id="grenade-left-btn"><div class="grenade-icon"></div></div>
                <div class="control-btn" id="grenade-right-btn"><div class="grenade-icon"></div></div>
                <div class="control-btn" id="grenade-down-btn"><div class="grenade-icon"></div></div>
            </div>
        </div>

        <div id="instructions">
            <h2>Soldado Granada</h2>
            <p>¬°Destruye los enemigos lanzando granadas!</p>
            <p>Usa las flechas para moverte y los botones de granada para atacar en cada direcci√≥n.</p>
            <p>Gana puntos por cada enemigo destruido.</p>
            <p>¬°Cuidado! Si un enemigo llega hasta ti, perder√°s una vida.</p>
            <button id="start-btn">JUGAR</button>
        </div>

        <div id="game-over">
            <h2>¬°JUEGO TERMINADO!</h2>
            <p id="final-score">Puntuaci√≥n: 0</p>
            <button id="restart-btn">JUGAR DE NUEVO</button>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const gameContainer = document.getElementById('game-container');
            const soldier = document.getElementById('soldier');
            const scoreDisplay = document.getElementById('score');
            const livesDisplay = document.getElementById('lives');
            const levelDisplay = document.getElementById('level');
            const upBtn = document.getElementById('up-btn');
            const downBtn = document.getElementById('down-btn');
            const leftBtn = document.getElementById('left-btn');
            const rightBtn = document.getElementById('right-btn');
            const grenadeUpBtn = document.getElementById('grenade-up-btn');
            const grenadeDownBtn = document.getElementById('grenade-down-btn');
            const grenadeLeftBtn = document.getElementById('grenade-left-btn');
            const grenadeRightBtn = document.getElementById('grenade-right-btn');
            const startBtn = document.getElementById('start-btn');
            const restartBtn = document.getElementById('restart-btn');
            const instructions = document.getElementById('instructions');
            const gameOverScreen = document.getElementById('game-over');
            const finalScoreDisplay = document.getElementById('final-score');
            const backgroundElements = document.getElementById('background-elements');

            let score = 0;
            let lives = 3;
            let level = 1;
            let enemiesToNextLevel = 5;
            let enemiesDefeated = 0;
            let gameActive = false;
            let grassPatches = [];
            let trees = [];
            let enemies = [];
            let grenades = [];
            let bullets = [];
            let explosions = [];
            let enemySpeed = 0.5;
            let enemySpawnRate = 3000;
            let lastEnemySpawnTime = 0;
            let gameLoop;
            let enemySpawner;
            let backgroundOffset = 0;
            let enemyDefeatCount = 0;
            let shootersThisLevel = 0;
            const maxShooters = 2;
            const soldierSpeed = 10;
            const bulletSpeed = 2;
            let soldierX = gameContainer.offsetWidth / 2;
            let soldierY = 150;
            let moveKeys = {};

            const GRAVITY = 1.0;

            const celebrationTexts = ['¬°Yeah!', '¬°Bien!', '¬°Perfecto!', '¬°As√≠ se hace!', '¬°Fant√°stico!', '¬°Incre√≠ble!', '¬°S√≠!'];
            const soldierTexts = [
                { text: '¬°Toma!', emoji: 'üí•' },
                { text: '¬°All√° va!', emoji: 'üí£' },
                { text: '¬°Biiien!', emoji: 'üòé' },
                { text: '¬°Ataque!', emoji: 'üî•' }
            ];
            const enemyTexts = [
                { text: '¬°Aaagghh!', emoji: 'üòµ' },
                { text: '¬°Noo!', emoji: 'üíÄ' },
                { text: '¬°Bum!', emoji: 'üí•' },
                { text: '¬°Adi√≥s!', emoji: 'üëã' }
            ];

            startBtn.addEventListener('click', startGame);
            restartBtn.addEventListener('click', startGame);

            const buttons = [
                { el: upBtn, dir: 'up', type: 'move' },
                { el: downBtn, dir: 'down', type: 'move' },
                { el: leftBtn, dir: 'left', type: 'move' },
                { el: rightBtn, dir: 'right', type: 'move' },
                { el: grenadeUpBtn, dir: 'up', type: 'grenade' },
                { el: grenadeDownBtn, dir: 'down', type: 'grenade' },
                { el: grenadeLeftBtn, dir: 'left', type: 'grenade' },
                { el: grenadeRightBtn, dir: 'right', type: 'grenade' }
            ];

            buttons.forEach(btn => {
                if (btn.type === 'move') {
                    btn.el.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (!gameActive) return;
                        moveKeys[btn.dir] = true;
                    });

                    btn.el.addEventListener('touchend', (e) => {
                        e.preventDefault();
                        if (!gameActive) return;
                        moveKeys[btn.dir] = false;
                    });

                    btn.el.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        if (!gameActive) return;
                        moveKeys[btn.dir] = true;
                    });

                    btn.el.addEventListener('mouseup', (e) => {
                        e.preventDefault();
                        if (!gameActive) return;
                        moveKeys[btn.dir] = false;
                    });

                } else if (btn.type === 'grenade') {
                    btn.el.addEventListener('touchstart', (e) => {
                        e.preventDefault();
                        if (!gameActive) return;
                        throwGrenade(btn.dir);
                    });

                    btn.el.addEventListener('mousedown', (e) => {
                        e.preventDefault();
                        if (!gameActive) return;
                        throwGrenade(btn.dir);
                    });
                }
            });

            document.addEventListener('keydown', (e) => {
                if (!gameActive) return;
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                        moveKeys.up = true;
                        break;
                    case 'ArrowDown':
                    case 's':
                        moveKeys.down = true;
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        moveKeys.left = true;
                        break;
                    case 'ArrowRight':
                    case 'd':
                        moveKeys.right = true;
                        break;
                    case 'q':
                        throwGrenade('up');
                        break;
                    case 'e':
                        throwGrenade('down');
                        break;
                    case 'z':
                        throwGrenade('left');
                        break;
                    case 'c':
                        throwGrenade('right');
                        break;
                }
            });

            document.addEventListener('keyup', (e) => {
                if (!gameActive) return;
                switch(e.key) {
                    case 'ArrowUp':
                    case 'w':
                        moveKeys.up = false;
                        break;
                    case 'ArrowDown':
                    case 's':
                        moveKeys.down = false;
                        break;
                    case 'ArrowLeft':
                    case 'a':
                        moveKeys.left = false;
                        break;
                    case 'ArrowRight':
                    case 'd':
                        moveKeys.right = false;
                        break;
                }
            });

            function startGame() {
                score = 0;
                lives = 3;
                level = 1;
                enemiesToNextLevel = 5;
                enemiesDefeated = 0;
                gameActive = true;
                backgroundOffset = 0;
                lastEnemySpawnTime = 0;
                enemyDefeatCount = 0;
                shootersThisLevel = 0;

                soldierX = (gameContainer.offsetWidth / 2) - (soldier.offsetWidth / 2);
                soldierY = 150;
                soldier.style.left = `${soldierX}px`;
                soldier.style.bottom = `${soldierY}px`;

                scoreDisplay.textContent = 'Puntos: 0';
                livesDisplay.textContent = 'Vidas: 3';
                levelDisplay.textContent = 'Nivel: 1';

                backgroundElements.style.transform = `translateY(${backgroundOffset}px)`;

                instructions.style.display = 'none';
                gameOverScreen.style.display = 'none';

                document.querySelectorAll('.enemy, .grenade, .explosion, .grass-patch, .explosion-particle, .tree, .celebration-text, .soldier-text, .enemy-text, .bullet').forEach(el => el.remove());

                createGrassPatches();
                createTrees();

                clearInterval(enemySpawner);
                lastEnemySpawnTime = Date.now();

                cancelAnimationFrame(gameLoop);
                gameLoop = requestAnimationFrame(updateGame);
            }

            function updateSoldierPosition() {
                let newX = soldierX;
                let newY = soldierY;
                const soldierWidth = 30;
                const soldierHeight = 60;
                const gameWidth = gameContainer.offsetWidth;
                const gameHeight = gameContainer.offsetHeight;

                if (moveKeys.up) newY += soldierSpeed;
                if (moveKeys.down) newY -= soldierSpeed;
                if (moveKeys.left) newX -= soldierSpeed;
                if (moveKeys.right) newX += soldierSpeed;

                newX = Math.max(0, Math.min(gameWidth - soldierWidth, newX));
                newY = Math.max(100, Math.min(gameHeight - soldierHeight - 20, newY));

                if (newX !== soldierX || newY !== soldierY) {
                    soldier.classList.add('walking');
                } else {
                    soldier.classList.remove('walking');
                }

                soldierX = newX;
                soldierY = newY;

                soldier.style.left = `${soldierX}px`;
                soldier.style.bottom = `${soldierY}px`;
            }

            function createGrassPatches() {
                document.querySelectorAll('.grass-patch').forEach(el => el.remove());
                grassPatches = [];

                const grassCount = 8;
                for (let i = 0; i < grassCount; i++) {
                    const grassPatch = document.createElement('div');
                    grassPatch.className = 'grass-patch';

                    const grassType = Math.floor(Math.random() * 3) + 1;
                    grassPatch.classList.add(`grass-patch-type-${grassType}`);

                    const top = Math.random() * 60 + 10;
                    let left;

                    if (Math.random() > 0.5) {
                        left = Math.random() * 18;
                    } else {
                        left = Math.random() * 18 + 82;
                    }

                    grassPatch.style.top = `${top}%`;
                    grassPatch.style.left = `${left}%`;
                    backgroundElements.appendChild(grassPatch);

                    grassPatches.push({
                        element: grassPatch,
                        top: top,
                        left: left,
                        type: grassType
                    });
                }
            }

            function createTrees() {
                document.querySelectorAll('.tree').forEach(el => el.remove());
                trees = [];

                const treeCount = 4;
                for (let i = 0; i < treeCount; i++) {
                    const tree = document.createElement('div');
                    tree.className = 'tree';

                    const trunk = document.createElement('div');
                    trunk.className = 'tree-trunk';

                    const top = document.createElement('div');
                    top.className = 'tree-top';

                    tree.appendChild(trunk);
                    tree.appendChild(top);

                    const topPos = Math.random() * 50 + 10;
                    let left;

                    if (Math.random() > 0.5) {
                        left = Math.random() * 15 + 2;
                    } else {
                        left = Math.random() * 15 + 83;
                    }

                    tree.style.top = `${topPos}%`;
                    tree.style.left = `${left}%`;
                    backgroundElements.appendChild(tree);

                    trees.push({
                        element: tree,
                        top: topPos,
                        left: left
                    });
                }
            }

            function updateGrassPatches() {
                for (let i = 0; i < grassPatches.length; i++) {
                    const grassPatch = grassPatches[i];
                    grassPatch.element.style.transform = `translateY(${backgroundOffset/5}px)`;
                }
            }

            function updateTrees() {
                for (let i = 0; i < trees.length; i++) {
                    const tree = trees[i];
                    tree.element.style.transform = `translateY(${backgroundOffset/5}px)`;
                }
            }

            function advanceLevel() {
                level++;
                enemiesDefeated = 0;
                enemiesToNextLevel = 5 + level * 2;

                enemySpeed += 0.1;
                enemySpawnRate = Math.max(1500, enemySpawnRate - 200);

                shootersThisLevel = 0;

                levelDisplay.textContent = `Nivel: ${level}`;

                backgroundOffset += 50;
                backgroundElements.style.transform = `translateY(${backgroundOffset}px)`;

                updateGrassPatches();
                updateTrees();

                const levelUpAnimation = document.createElement('div');
                levelUpAnimation.className = 'level-up-animation';
                levelUpAnimation.textContent = `NIVEL ${level}`;
                gameContainer.appendChild(levelUpAnimation);

                setTimeout(() => {
                    gameContainer.removeChild(levelUpAnimation);
                }, 1500);
            }

            function createEnemy() {
                if (!gameActive) return;

                const enemy = document.createElement('div');
                enemy.className = 'enemy';

                const enemyHead = document.createElement('div');
                enemyHead.className = 'enemy-head';

                const enemyHelmet = document.createElement('div');
                enemyHelmet.className = 'enemy-helmet';

                const enemyBody = document.createElement('div');
                enemyBody.className = 'enemy-body';

                const enemyArmLeft = document.createElement('div');
                enemyArmLeft.className = 'enemy-arm left';

                const enemyArmRight = document.createElement('div');
                enemyArmRight.className = 'enemy-arm right';

                const enemyLegLeft = document.createElement('div');
                enemyLegLeft.className = 'enemy-leg left';

                const enemyLegRight = document.createElement('div');
                enemyLegRight.className = 'enemy-leg right';

                const enemyWeapon = document.createElement('div');
                enemyWeapon.className = 'enemy-weapon';

                enemy.appendChild(enemyHead);
                enemy.appendChild(enemyHelmet);
                enemy.appendChild(enemyBody);
                enemy.appendChild(enemyArmLeft);
                enemy.appendChild(enemyArmRight);
                enemy.appendChild(enemyLegLeft);
                enemy.appendChild(enemyLegRight);
                enemy.appendChild(enemyWeapon);

                let isShooter = false;
                if (shootersThisLevel < maxShooters) {
                    const randomShooterChance = Math.random();
                    if (randomShooterChance > 0.6) {
                        isShooter = true;
                        shootersThisLevel++;
                    }
                }

                const side = Math.random() > 0.5 ? 'right' : 'left';
                const xPosition = side === 'left' ? -30 : gameContainer.offsetWidth;
                let yPosition;

                if (isShooter) {
                    const isHighShooter = Math.random() > 0.5;
                    yPosition = isHighShooter ? 250 + (Math.random() * 150) : 150 + (Math.random() * 100);
                } else {
                    yPosition = 100 + (Math.random() * 200);
                }

                enemy.style.left = `${xPosition}px`;
                enemy.style.bottom = `${yPosition}px`;
                enemy.style.display = 'block';

                gameContainer.appendChild(enemy);

                enemy.classList.add('moving');

                const enemyType = Math.random();
                let speedMultiplier = 1;
                let isCrab = false;

                if (enemyType < 0.3) {
                    speedMultiplier = 0.6;
                } else if (enemyType < 0.6) {
                    speedMultiplier = 1;
                } else {
                    speedMultiplier = 0.8;
                    isCrab = true;
                    enemy.classList.add('crab-moving');
                }

                enemies.push({
                    element: enemy,
                    side: side,
                    x: xPosition,
                    y: yPosition,
                    width: 30,
                    height: 60,
                    state: 'moving',
                    active: true,
                    speedMultiplier: speedMultiplier,
                    isCrab: isCrab,
                    crabDirection: side === 'left' ? 1 : -1,
                    isShooter: isShooter,
                    lastShotTime: Date.now()
                });
            }

            function createBullet(enemy) {
                const bullet = document.createElement('div');
                bullet.className = 'bullet';

                const enemyRect = enemy.element.getBoundingClientRect();
                const bulletX = enemyRect.left + enemyRect.width / 2;
                const bulletY = enemyRect.top + enemyRect.height / 2;

                bullet.style.left = `${bulletX}px`;
                bullet.style.top = `${bulletY}px`;
                gameContainer.appendChild(bullet);

                const soldierRect = soldier.getBoundingClientRect();
                const targetX = soldierRect.left + soldierRect.width / 2;
                const targetY = soldierRect.top + soldierRect.height / 2;

                const angle = Math.atan2(targetY - bulletY, targetX - bulletX);

                bullets.push({
                    element: bullet,
                    x: bulletX,
                    y: bulletY,
                    velocityX: Math.cos(angle) * bulletSpeed,
                    velocityY: Math.sin(angle) * bulletSpeed,
                    active: true
                });
            }

            function updateBulletPosition(bullet) {
                bullet.x += bullet.velocityX;
                bullet.y += bullet.velocityY;

                bullet.element.style.left = `${bullet.x}px`;
                bullet.element.style.top = `${bullet.y}px`;

                if (bullet.x < 0 || bullet.x > gameContainer.offsetWidth || bullet.y < 0 || bullet.y > gameContainer.offsetHeight) {
                    bullet.active = false;
                    bullet.element.remove();
                }
            }

            function checkBulletCollisions() {
                const soldierRect = soldier.getBoundingClientRect();

                for (let i = bullets.length - 1; i >= 0; i--) {
                    const bullet = bullets[i];
                    if (!bullet.active) continue;

                    const bulletRect = bullet.element.getBoundingClientRect();

                    if (
                        bulletRect.left < soldierRect.right &&
                        bulletRect.right > soldierRect.left &&
                        bulletRect.top < soldierRect.bottom &&
                        bulletRect.bottom > soldierRect.top
                    ) {
                        bullet.active = false;
                        bullet.element.remove();
                        loseLife();
                    }
                }
            }

            function throwGrenade(direction) {
                soldier.classList.add('grenade-throw');
                showSoldierText();

                setTimeout(() => {
                    soldier.classList.remove('grenade-throw');
                }, 300);

                setTimeout(() => {
                    const grenade = document.createElement('div');
                    grenade.className = 'grenade';

                    const soldierRect = soldier.getBoundingClientRect();
                    const startX = soldierRect.left + soldierRect.width / 2;
                    const startY = soldierRect.top + soldierRect.height / 2;

                    grenade.style.left = `${startX}px`;
                    grenade.style.top = `${startY}px`;

                    gameContainer.appendChild(grenade);

                    let velocityX, velocityY;
                    const initialSpeed = 8;
                    const initialVerticalSpeed = -6;

                    switch(direction) {
                        case 'up':
                            velocityX = 0;
                            velocityY = initialVerticalSpeed * 1.5;
                            break;
                        case 'down':
                            velocityX = 0;
                            velocityY = -initialVerticalSpeed * 0.5;
                            break;
                        case 'left':
                            velocityX = -initialSpeed;
                            velocityY = initialVerticalSpeed;
                            break;
                        case 'right':
                            velocityX = initialSpeed;
                            velocityY = initialVerticalSpeed;
                            break;
                    }

                    grenades.push({
                        element: grenade,
                        x: startX,
                        y: startY,
                        velocityX: velocityX,
                        velocityY: velocityY,
                        active: true,
                        bounces: 0
                    });
                }, 100);
            }

            function updateGrenadePosition(grenade) {
                grenade.x += grenade.velocityX;
                grenade.y += grenade.velocityY;
                grenade.velocityY += GRAVITY;

                const grenadeRect = grenade.element.getBoundingClientRect();

                if (grenade.x <= 0 || grenade.x + grenadeRect.width >= gameContainer.offsetWidth) {
                    grenade.velocityX *= -0.7;
                    grenade.x = grenade.x <= 0 ? 0 : gameContainer.offsetWidth - grenadeRect.width;
                }

                if (grenade.y + grenadeRect.height >= gameContainer.offsetHeight - 100) {
                    grenade.velocityY *= -0.5;
                    grenade.y = gameContainer.offsetHeight - 100 - grenadeRect.height;
                    grenade.bounces++;
                    if (grenade.bounces >= 1) {
                        explodeGrenade(grenade, null);
                        return;
                    }
                }

                if (grenade.x < -100 || grenade.x > gameContainer.offsetWidth + 100 || grenade.y > gameContainer.offsetHeight + 100) {
                    grenade.active = false;
                    grenade.element.remove();
                    return;
                }

                grenade.element.style.left = `${grenade.x}px`;
                grenade.element.style.top = `${grenade.y}px`;

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    if (!enemy.active) continue;

                    const enemyRect = enemy.element.getBoundingClientRect();

                    if (
                        grenadeRect.left < enemyRect.right &&
                        grenadeRect.right > enemyRect.left &&
                        grenadeRect.top < enemyRect.bottom &&
                        grenadeRect.bottom > enemyRect.top
                    ) {
                        explodeGrenade(grenade, enemy);
                        return;
                    }
                }
            }

            function explodeGrenade(grenade, enemy) {
                if (!grenade.active) return;
                grenade.active = false;
                grenade.element.remove();

                const explosion = document.createElement('div');
                explosion.className = 'explosion';
                explosion.style.left = `${grenade.x - 40}px`;
                explosion.style.top = `${grenade.y - 40}px`;

                gameContainer.appendChild(explosion);

                for (let i = 0; i < 10; i++) {
                    const particle = document.createElement('div');
                    particle.className = 'explosion-particle';
                    particle.style.left = `${grenade.x}px`;
                    particle.style.top = `${grenade.y}px`;

                    const angle = Math.random() * Math.PI * 2;
                    const distance = 30 + Math.random() * 50;
                    const tx = Math.cos(angle) * distance;
                    const ty = Math.sin(angle) * distance;

                    particle.style.setProperty('--tx', `${tx}px`);
                    particle.style.setProperty('--ty', `${ty}px`);

                    gameContainer.appendChild(particle);

                    setTimeout(() => {
                        particle.remove();
                    }, 300);
                }

                setTimeout(() => {
                    explosion.remove();
                }, 300);

                checkEnemyCollisions(grenade.x, grenade.y);
            }

            function checkEnemyCollisions(x, y) {
                let hitCount = 0;

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    if (!enemy.active) continue;

                    const enemyRect = enemy.element.getBoundingClientRect();
                    const distance = Math.sqrt(
                        Math.pow(x - (enemyRect.left + enemyRect.width / 2), 2) +
                        Math.pow(y - (enemyRect.top + enemyRect.height / 2), 2)
                    );

                    if (distance < 60) {
                        enemy.active = false;
                        enemy.element.style.opacity = 0;

                        showEnemyText(enemy);

                        setTimeout(() => {
                            enemy.element.remove();
                        }, 500);

                        score += 10;
                        scoreDisplay.textContent = `Puntos: ${score}`;

                        enemiesDefeated++;
                        hitCount++;
                        enemyDefeatCount++;

                        if (enemyDefeatCount >= 4) {
                            enemyDefeatCount = 0;
                            showCelebrationText();
                        }

                        if (enemiesDefeated >= enemiesToNextLevel) {
                            advanceLevel();
                        }
                    }
                }

                return hitCount;
            }

            function showCelebrationText() {
                const randomText = celebrationTexts[Math.floor(Math.random() * celebrationTexts.length)];
                const celebrationText = document.createElement('div');
                celebrationText.className = 'celebration-text';
                celebrationText.textContent = randomText;
                celebrationText.style.left = `${soldier.offsetLeft + soldier.offsetWidth / 2}px`;
                celebrationText.style.top = `${soldier.offsetTop - 50}px`;

                gameContainer.appendChild(celebrationText);

                setTimeout(() => {
                    gameContainer.removeChild(celebrationText);
                }, 2000);
            }

            function showSoldierText() {
                const randomTextObj = soldierTexts[Math.floor(Math.random() * soldierTexts.length)];
                const soldierTextEl = document.createElement('div');
                soldierTextEl.className = 'soldier-text';
                soldierTextEl.textContent = `${randomTextObj.text} ${randomTextObj.emoji}`;
                soldierTextEl.style.left = `${soldier.offsetLeft + soldier.offsetWidth / 2}px`;
                soldierTextEl.style.top = `${soldier.offsetTop - 50}px`;

                gameContainer.appendChild(soldierTextEl);

                setTimeout(() => {
                    gameContainer.removeChild(soldierTextEl);
                }, 1500);
            }

            function showEnemyText(enemy) {
                const randomTextObj = enemyTexts[Math.floor(Math.random() * enemyTexts.length)];
                const enemyTextEl = document.createElement('div');
                enemyTextEl.className = 'enemy-text';
                enemyTextEl.textContent = `${randomTextObj.text} ${randomTextObj.emoji}`;
                enemyTextEl.style.left = `${enemy.element.offsetLeft + enemy.element.offsetWidth / 2}px`;
                enemyTextEl.style.top = `${enemy.element.offsetTop - 30}px`;

                gameContainer.appendChild(enemyTextEl);

                setTimeout(() => {
                    gameContainer.removeChild(enemyTextEl);
                }, 1500);
            }

            function updateEnemyPosition(enemy) {
                if (enemy.isCrab) {
                    enemy.x += enemy.crabDirection * enemySpeed * enemy.speedMultiplier;
                    enemy.element.style.left = `${enemy.x}px`;

                    if (enemy.x <= 0 || enemy.x >= gameContainer.offsetWidth - enemy.width) {
                        enemy.crabDirection *= -1;
                    }
                } else {
                    const direction = enemy.side === 'left' ? 1 : -1;
                    enemy.x += direction * enemySpeed * enemy.speedMultiplier;
                    enemy.element.style.left = `${enemy.x}px`;
                }

                if (enemy.isShooter && Date.now() - enemy.lastShotTime > 2000) {
                    createBullet(enemy);
                    enemy.lastShotTime = Date.now();
                }

                const soldierRect = soldier.getBoundingClientRect();
                const enemyRect = enemy.element.getBoundingClientRect();

                if (
                    enemyRect.left < soldierRect.right &&
                    enemyRect.right > soldierRect.left &&
                    enemyRect.top < soldierRect.bottom &&
                    enemyRect.bottom > soldierRect.top
                ) {
                    enemy.active = false;
                    enemy.element.remove();
                    loseLife();
                }

                if (enemy.x < -50 || enemy.x > gameContainer.offsetWidth + 50) {
                    enemy.active = false;
                    enemy.element.remove();
                }
            }

            function loseLife() {
                lives--;
                livesDisplay.textContent = `Vidas: ${lives}`;

                soldier.style.animation = 'shake 0.5s';
                setTimeout(() => {
                    soldier.style.animation = '';
                }, 500);

                if (lives <= 0) {
                    gameOver();
                }
            }

            function gameOver() {
                gameActive = false;
                finalScoreDisplay.textContent = `Puntuaci√≥n: ${score}`;
                gameOverScreen.style.display = 'flex';

                clearInterval(enemySpawner);
                cancelAnimationFrame(gameLoop);
            }

            function updateGame() {
                if (!gameActive) return;

                const currentTime = Date.now();

                if (currentTime - lastEnemySpawnTime > enemySpawnRate) {
                    createEnemy();
                    lastEnemySpawnTime = currentTime;
                }

                updateSoldierPosition();

                for (let i = grenades.length - 1; i >= 0; i--) {
                    const grenade = grenades[i];
                    if (grenade.active) {
                        updateGrenadePosition(grenade);
                    } else {
                        grenades.splice(i, 1);
                    }
                }

                for (let i = bullets.length - 1; i >= 0; i--) {
                    const bullet = bullets[i];
                    if (bullet.active) {
                        updateBulletPosition(bullet);
                    } else {
                        bullets.splice(i, 1);
                    }
                }

                checkBulletCollisions();

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const enemy = enemies[i];
                    if (enemy.active) {
                        updateEnemyPosition(enemy);
                    } else {
                        enemies.splice(i, 1);
                    }
                }

                gameLoop = requestAnimationFrame(updateGame);
            }
        });
    </script>
</body>
</html>